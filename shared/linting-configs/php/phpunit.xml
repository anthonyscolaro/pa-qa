<?xml version="1.0" encoding="UTF-8"?>
<phpunit xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:noNamespaceSchemaLocation="https://schema.phpunit.de/10.5/phpunit.xsd"
         bootstrap="vendor/autoload.php"
         colors="true"
         processIsolation="false"
         stopOnFailure="false"
         stopOnError="false"
         stopOnIncomplete="false"
         stopOnSkipped="false"
         stopOnRisky="false"
         failOnRisky="true"
         failOnWarning="true"
         failOnIncomplete="false"
         failOnSkipped="false"
         beStrictAboutChangesToGlobalState="true"
         beStrictAboutOutputDuringTests="true"
         beStrictAboutResourceUsageDuringSmallTests="true"
         beStrictAboutTestsThatDoNotTestAnything="true"
         beStrictAboutTodoAnnotatedTests="true"
         beStrictAboutCoversAnnotation="true"
         enforceTimeLimit="true"
         defaultTimeLimit="10"
         timeoutForSmallTests="5"
         timeoutForMediumTests="30"
         timeoutForLargeTests="120"
         executionOrder="default"
         resolveDependencies="true"
         cacheDirectory="build/phpunit/cache"
         backupGlobals="false"
         backupStaticAttributes="false"
>
    <!-- Test suites -->
    <testsuites>
        <!-- Unit tests -->
        <testsuite name="Unit">
            <directory>tests/Unit</directory>
            <directory>tests/unit</directory>
        </testsuite>

        <!-- Feature tests -->
        <testsuite name="Feature">
            <directory>tests/Feature</directory>
            <directory>tests/feature</directory>
        </testsuite>

        <!-- Integration tests -->
        <testsuite name="Integration">
            <directory>tests/Integration</directory>
            <directory>tests/integration</directory>
        </testsuite>

        <!-- End-to-end tests -->
        <testsuite name="E2E">
            <directory>tests/E2E</directory>
            <directory>tests/e2e</directory>
        </testsuite>

        <!-- WordPress specific tests -->
        <testsuite name="WordPress">
            <directory>tests/WordPress</directory>
            <directory>tests/wordpress</directory>
            <directory>tests/wp</directory>
        </testsuite>

        <!-- Laravel specific tests -->
        <testsuite name="Laravel">
            <directory>tests/Laravel</directory>
            <directory>tests/laravel</directory>
        </testsuite>

        <!-- Performance tests -->
        <testsuite name="Performance">
            <directory>tests/Performance</directory>
            <directory>tests/performance</directory>
            <directory>tests/benchmark</directory>
        </testsuite>

        <!-- Security tests -->
        <testsuite name="Security">
            <directory>tests/Security</directory>
            <directory>tests/security</directory>
        </testsuite>
    </testsuites>

    <!-- Source code for coverage -->
    <source>
        <include>
            <directory>src</directory>
            <directory>app</directory>
        </include>
        <exclude>
            <directory>vendor</directory>
            <directory>node_modules</directory>
            <directory>storage</directory>
            <directory>bootstrap/cache</directory>
            <directory>public</directory>
            <directory>build</directory>
            <directory>dist</directory>
            <file>app/Http/Kernel.php</file>
            <file>app/Console/Kernel.php</file>
            <file>app/Exceptions/Handler.php</file>
            <file>app/Providers/RouteServiceProvider.php</file>
            <file>app/Http/Middleware/TrustProxies.php</file>
            <file>app/Http/Middleware/TrustHosts.php</file>
            <directory>database/migrations</directory>
            <directory>database/seeders</directory>
            <directory>database/factories</directory>
        </exclude>
    </source>

    <!-- Coverage reports -->
    <coverage includeUncoveredFiles="true"
              processUncoveredFiles="true"
              pathCoverage="false"
              ignoreDeprecatedCodeUnits="true"
              disableCodeCoverageIgnore="false">
        <report>
            <!-- HTML coverage report -->
            <html outputDirectory="build/coverage/html" lowUpperBound="50" highLowerBound="80"/>
            
            <!-- Clover XML for CI/CD -->
            <clover outputFile="build/coverage/clover.xml"/>
            
            <!-- Cobertura XML for some CI systems -->
            <cobertura outputFile="build/coverage/cobertura.xml"/>
            
            <!-- Text coverage for console output -->
            <text outputFile="build/coverage/coverage.txt" showUncoveredFiles="false" showOnlySummary="false"/>
        </report>
    </coverage>

    <!-- Logging -->
    <logging>
        <!-- JUnit XML for CI/CD -->
        <junit outputFile="build/junit.xml"/>
        
        <!-- TeamCity output -->
        <teamcity outputFile="build/teamcity.txt"/>
        
        <!-- Plain text log -->
        <testdoxText outputFile="build/testdox.txt"/>
        
        <!-- HTML test documentation -->
        <testdoxHtml outputFile="build/testdox.html"/>
    </logging>

    <!-- PHP settings -->
    <php>
        <!-- Environment variables -->
        <env name="APP_ENV" value="testing"/>
        <env name="APP_DEBUG" value="true"/>
        <env name="APP_KEY" value="base64:SGVsbG9Xb3JsZEtleUZvclRlc3RpbmdQdXJwb3Nlcw=="/>
        
        <!-- Database settings -->
        <env name="DB_CONNECTION" value="sqlite"/>
        <env name="DB_DATABASE" value=":memory:"/>
        <env name="DB_FOREIGN_KEYS" value="true"/>
        
        <!-- Cache and session -->
        <env name="CACHE_DRIVER" value="array"/>
        <env name="SESSION_DRIVER" value="array"/>
        <env name="QUEUE_CONNECTION" value="sync"/>
        
        <!-- Mail -->
        <env name="MAIL_MAILER" value="array"/>
        
        <!-- Logging -->
        <env name="LOG_CHANNEL" value="single"/>
        <env name="LOG_LEVEL" value="debug"/>
        
        <!-- Broadcasting -->
        <env name="BROADCAST_DRIVER" value="log"/>
        
        <!-- Filesystem -->
        <env name="FILESYSTEM_DISK" value="local"/>
        
        <!-- WordPress specific -->
        <env name="WP_TESTS_DIR" value="/tmp/wordpress-tests-lib"/>
        <env name="WP_CORE_DIR" value="/tmp/wordpress"/>
        <env name="WP_TESTS_DOMAIN" value="example.org"/>
        <env name="WP_TESTS_EMAIL" value="admin@example.org"/>
        <env name="WP_TESTS_TITLE" value="Test Site"/>
        <env name="WP_PHP_BINARY" value="php"/>
        <env name="WP_TESTS_FORCE_KNOWN_BUGS" value="false"/>
        
        <!-- Testing utilities -->
        <env name="TELESCOPE_ENABLED" value="false"/>
        <env name="DEBUGBAR_ENABLED" value="false"/>
        
        <!-- Performance testing -->
        <env name="MEMORY_LIMIT" value="512M"/>
        <env name="MAX_EXECUTION_TIME" value="300"/>
        
        <!-- Security testing -->
        <env name="BCRYPT_ROUNDS" value="4"/>
        <env name="HASH_DRIVER" value="bcrypt"/>
        
        <!-- PHP ini settings -->
        <ini name="memory_limit" value="512M"/>
        <ini name="max_execution_time" value="300"/>
        <ini name="error_reporting" value="E_ALL"/>
        <ini name="display_errors" value="1"/>
        <ini name="display_startup_errors" value="1"/>
        <ini name="log_errors" value="1"/>
        <ini name="assert.exception" value="1"/>
        
        <!-- Server variables -->
        <server name="SERVER_NAME" value="localhost"/>
        <server name="REQUEST_URI" value="/"/>
        <server name="REQUEST_METHOD" value="GET"/>
        <server name="HTTP_HOST" value="localhost"/>
        <server name="HTTPS" value="false"/>
    </php>

    <!-- Extensions -->
    <extensions>
        <!-- Allure reporting integration -->
        <extension class="Qameta\Allure\PHPUnit\AllureExtension">
            <arguments>
                <string>build/allure-results</string>
                <boolean>true</boolean>
                <array>
                    <element key="host">
                        <string>allure.projectassistant.ai</string>
                    </element>
                    <element key="project">
                        <string>pa-qa-php</string>
                    </element>
                </array>
            </arguments>
        </extension>
        
        <!-- Memory usage extension -->
        <extension class="PHPUnit\MemoryUsage\MemoryUsageExtension"/>
        
        <!-- Speed trap extension -->
        <extension class="PHPUnit\SpeedTrap\SpeedTrapListener">
            <arguments>
                <array>
                    <element key="slowThreshold">
                        <integer>500</integer>
                    </element>
                    <element key="reportLength">
                        <integer>10</integer>
                    </element>
                </array>
            </arguments>
        </extension>
    </extensions>

    <!-- Groups -->
    <groups>
        <!-- Exclude groups -->
        <exclude>
            <group>slow</group>
            <group>external</group>
            <group>integration</group>
            <group>legacy</group>
        </exclude>
    </groups>

</phpunit>